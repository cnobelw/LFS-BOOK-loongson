设备和模块处理概述
===================================
在第6章中，我们在systemd构建时安装了Udev软件包。在讨论如何工作的细节之前，先了解以前处理设备的方法的简要历史记录。
传统上，Linux系统通常使用静态设备创建方法，因此/dev无论相应的硬件设备是否真实存在，都会创建很多设备节点(有时几千个节点)。这通常是通过一个MAKEDEV脚本完成的，该脚本包含许多对mknod程序的调用，以及对于世界上可能存在的每种可能设备的相关主要和次要设备编号。
使用Udev方法，只有内核检测到的那些设备才会为它们创建设备节点。因为每次系统引导时都会创建这些设备节点，所以它们将存储在 devtmpfs文件系统(完全驻留在系统内存中的虚拟文件系统)中。设备节点不需要太多空间，所以使用的内存可以忽略不计。
________________________________________
## 历史

2000年2月，一个新的文件系统devfs被合并到2.3.46内核中，并在2.4系列稳定内核期间可用。虽然它出现在内核源码本身中，但这种动态创建设备的方法从未得到核心内核开发人员的强大支持。
这种方法的主要问题在于devfs它处理设备检测，创建和命名的方式。后一个问题，即设备节点​​命名，可能是最关键的。一般认为，如果允许设备名称是可配置的，那么设备命名策略应该由系统管理员决定，而不是由任何特定的开发人员强加给他们。该devfs文件系统还存在竞争条件是在其设计中固有的，无法固定而大幅修改内核遭遇。它被标记为很长一段时间 - 由于缺乏维护 - 最终在2006年6月从内核中删除。

随着不稳定2.5内核树的发展，后来发布为2.6系列稳定内核，一个新的虚拟文件系统被调用sysfs。其工作sysfs就是将系统硬件配置的视图导出到用户空间进程。通过这个用户空间可见的表示，开发用户空间替换的可能性devfs变得更加现实。

___________________________________

## Udev实现
### SYSFS
该sysfs文件系统被简要提及。有人可能会想知道如何sysfs知道系统中存在的设备以及应该使用哪些设备编号。当内核sysfs检测到它们时，已经编译到内核中的驱动程序直接在内部注册它们的对象(内部为devtmpfs)。对于编译为模块的驱动程序，当模块加载时会进行注册。一旦sysfs文件系统被挂载(在/sys上)，驱动程序注册的数据sysfs可用于用户空间进程和udevd进行处理(包括对设备节点的修改)。

### 设备节点创建

设备文件由内核由devtmpfs文件系统创建。任何希望注册设备节点devtmpfs的驱动程序都会通过(通过驱动程序核心)来完成。当devtmpfs安装实例时`/dev`，设备节点最初将使用固定的名称，权限和所有者创建。
不久之后，内核会发送一条消息给udevd。基于在内的文件中指定的规则`/etc/udev/rules.d`，`/lib/udev/rules.d`和`/run/udev/rules.d`目录，udevd会将创建的符号链接附加到该设备节点，或改变它的权限，拥有者，或修改内部的udevd该对象数据库条目(名称)。
这三个目录中的规则被编号，所有三个目录合并在一起。如果udevd无法找到它正在创建的设备的规则，则会在devtmpfs 最初使用的设备上留下权限和所有权。

### 模块加载

作为模块编译的设备驱动程序可能会内置别名。别名在modinfo程序的输出中可见，并且通常与模块支持的设备的总线特定标识符相关。例如，snd-fm801驱动程序支持具有供应商ID 0x1319和设备ID 0x0801的PCI设备，并具有“ pci：v00001319d00000801sv * sd * bc04sc01i * ”的别名。对于大多数设备，总线驱动程序会导出将通过设备处理设备的驱动程序的别名sysfs。例如，该/sys/bus/pci/devices/0000:00:0d.0/modalias文件可能包含字符串“ pci：v00001319d00000801sv00001319sd00001319bc04sc01i00“。Udev提供的默认规则将导致udevd使用uevent环境变量的内容(应该与sysfs中的文件的内容相同)调用/sbin/modprobe，从而加载所有其别名与此字符串匹配的模块通配符扩展后的MODALIASmodalias
在这个例子中，这意味着，除了snd-fm801之外，过时的(和不需要的)forte驱动程序如果可用则将被加载。请参阅下文，了解如何防止加载不需要的驱动程序。
内核本身也能够根据需要加载用于网络协议，文件系统和NLS支持的模块。


### 处理热插拔/动态设备

当您插入设备时，例如通用串行总线(USB)MP3播放器，内核会识别出设备现在已连接并生成一个uevent。如上所述，该事件随后由udevd处理 。
_________________________________________________________________
## 加载模块和创建设备的问题
自动创建设备节点时有几个可能的问题。

#### 内核模块不会自动加载

如果Udev具有总线专用别名，并且总线驱动程序正确导出必要的别名，则Udev将只加载模块sysfs。在其他情况下，应该通过其他方式安排模块加载。使用Linux-4.15.3，Udev可以为INPUT，IDE，PCI，USB，SCSI，SERIO和FireWire设备加载正确编写的驱动程序。
要确定您需要的设备驱动程序是否具有对Udev的必要支持，请以模块名称作为参数运行modinfo。现在尝试查找设备目录下，/sys/bus并检查是否有一个modalias文件。
如果modalias文件存在sysfs，驱动程序支持该设备并可以直接与它通话，但没有别名，这是驱动程序中的错误。在没有Udev帮助的情况下加载驱动程序，并期待稍后解决问题。
如果modalias在相关目录下没有文件/sys/bus，这意味着内核开发者还没有为这种总线类型添加modalias支持。在Linux-4.15.3中，ISA总线就是这种情况。预计此问题将在以后的内核版本中修复。
Udev不打算加载 诸如snd-pcm-oss之类的“包装器”驱动程序，以及诸如循环之类的非硬件驱动程序。

### 内核模块不会自动加载，Udev不会加载它

如果“包装器”模块仅增强某些其他模块提供的功能(例如snd-pcm-oss通过使声卡可用于OSS应用程序来增强snd-pcm的功能)，则配置modprobe以在Udev加载之后加载包装器包装的模块。为此，请将“softdep”行添加到相应的文件中。例如:
```
/etc/modprobe.d/<filename>.conf
softdep snd-pcm post: snd-pcm-oss
```

请注意，“softdep”命令也允许 pre:依赖关系，或两者的混合物pre:和post:。有关“softdep 语法和功能的modprobe.d(5)更多信息，请参见手册页。

如果所讨论的模块不是包装器并且本身很有用，请配置模块 bootscript以在系统引导时加载此模块。为此，请/etc/sysconfig/modules在单独的行中将模块名称添加到文件中。这也适用于包装模块，但在这种情况下是不理想的。

### Udev加载一些不需要的模块

要么不建立模块，要么/etc/modprobe.d/blacklist.conf像下面例子中的forte模块一样将它黑名单列入文件中：
```
blacklist forte
```

列入黑名单的模块仍可以使用明确的modprobe 命令手动加载。

#### Udev错误地创建了一个设备，或者造成了错误的符号链接
如果规则意外与设备匹配，通常会发生这种情况。例如，编写不好的规则可以按照供应商的要求(根据需要)和相应的SCSI通用设备(不正确)匹配。在udevadm info命令的帮助下查找违规规则并使其更具体。

### Udev统治不可靠
这可能是前一个问题的另一种表现。如果没有，并且您的规则使用sysfs属性，则可能是内核计时问题，需要在以后的内核中修复。现在，您可以通过创建一个等待使用的sysfs属性并将其附加到/etc/udev/rules.d/10-wait_for_sysfs.rules文件(如果该文件不存在，则创建该文件)来解决该问题。如果你这样做，请通知LFS发展名单，这对你有所帮助。

### Udev不创建设备
更多的文本假定驱动程序是静态构建到内核中的，或者已经作为模块加载，并且您已经检查过Udev没有创建错误的设备。

如果内核驱动程序不将数据导出到Udev，则无需创建设备节点的信息sysfs。这在内核树之外的第三方驱动程序中最为常见。/lib/udev/devices使用适当的主/次编号创建一个静态设备节点(请参阅devices.txt内核文档中的文件或由第三方驱动程序供应商提供的文档)。静态设备节点将被复制到/dev由udev的。

#### 设备命名顺序在重启后随机更改
这是由于Udev在设计上处理事件并且以并行的方式加载模块，因此以不可预知的顺序。这永远不会“ 固定 ”。您不应该依赖内核设备名称的稳定性。相反，应根据设备的某些稳定属性(例如序列号或Udev安装的各种*_id实用程序的输出)创建自己的规则，以便使用稳定的名称创建符号链接。有关示例，请参见第7.4节“管理设备”和第7.2节“常规网络配置”。
_________________________________________________________________________
## 有用的阅读

以下网站提供了其他有用的文档：
用户空间实现devfs http://www.kroah.com/linux/talks/ols_2003_udev_paper/Reprint-Kroah-Hartman-OLS2003.pdf
该sysfs文件系统 http://www.kernel.org/pub/linux/kernel/people/mochel/doc/papers/ols-2005/mochel.pdf
